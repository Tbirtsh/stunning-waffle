<!DOCTYPE html>
<html>
<head>
  <title>Tic Tac Toe - Multiplayer</title>
</head>
<body>
  <h1>Tic Tac Toe - Multiplayer</h1>
  <div id="board">
    <div class="row">
      <div class="cell" data-cell-index="0"></div>
      <div class="cell" data-cell-index="1"></div>
      <div class="cell" data-cell-index="2"></div>
    </div>
    <div class="row">
      <div class="cell" data-cell-index="3"></div>
      <div class="cell" data-cell-index="4"></div>
      <div class="cell" data-cell-index="5"></div>
    </div>
    <div class="row">
      <div class="cell" data-cell-index="6"></div>
      <div class="cell" data-cell-index="7"></div>
      <div class="cell" data-cell-index="8"></div>
    </div>
  </div>
  <script>
    const board = document.getElementById("board");
    const cells = board.querySelectorAll(".cell");
    let currentPlayer = "";
    let gameEnded = false;
    let websocket = null;

    // Connect to the WebSocket server
    function connect() {
      websocket = new WebSocket("ws://localhost:3000");

      websocket.onopen = function() {
        console.log("WebSocket connection established.");
      };

      websocket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        console.log("Received message:", message);

        if (message.type === "startGame") {
          currentPlayer = message.player;
          console.log(`You are player ${currentPlayer}`);

          for (let i = 0; i < cells.length; i++) {
            cells[i].addEventListener("click", () => {
              if (gameEnded || cells[i].textContent !== "") {
                return;
              }

              if (currentPlayer === "X") {
                cells[i].textContent = "X";
                cells[i].style.color = "red";
              } else {
                cells[i].textContent = "O";
                cells[i].style.color = "blue";
              }

              websocket.send(JSON.stringify({
                type: "makeMove",
                cellIndex: i
              }));
            });
          }
        } else if (message.type === "cellUpdate") {
          cells[message.cellIndex].textContent = message.player;
          cells[message.cellIndex].style.color = message.player === "X" ? "red" : "blue";
          currentPlayer = currentPlayer === "X" ? "O" : "X";
        } else if (message.type === "gameOver") {
          if (message.result === "draw") {
            alert("The game is a draw!");
          } else {
            alert(`Player ${message.result} has won!`);
          }

          gameEnded = true;
        } else if (message.type === "playerDisconnect") {
          alert("The other player has disconnected.");
          gameEnded = true;
        }
      };

      websocket.onclose = function() {
        console.log("WebSocket connection closed.");
      };
    }

      // Connect to the WebSocket server
    connect();

    function sendMessage(message) {
      if (websocket !== null && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify(message));
      }
    }

    window.addEventListener("beforeunload", () => {
      if (websocket !== null && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: "disconnect"
        }));
        websocket.close();
      }
    });
  </script>
</body>
</html>

